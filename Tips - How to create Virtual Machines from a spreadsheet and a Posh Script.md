# How to create Virtual Machines from a spreadsheet and a Posh Script

This demonstration uses Cmdlets from the Posh module HyperV. If the hypervisor is different, the principles are the same.
i.e. VMware.VimAutomation.Core or the other modules for VMWare infrastructure.

We'll build our virtual environment based on a .csv file with all necessary informations.

## First Step : Create a .csv file

![Infra.csv](./Images/infra-csv.png "Infra in a .csv file")

As you can see, in this first step I've only completed few informations : VMName, Memory VMGeneration, but you can add all necessary informations to build a complete infrastructure.

## Second Step : Import the .csv file in Posh

````powershell
$VMsList = Import-Csv -Path 'C:\users\Olivier\Desktop\Infra.csv'
Name Memory      CPU
---- ------      ---
VM1  1073741824  2
VM2  42994967296 2
VM3  536870912   2
# You can also add other parameters with the cmdlet Import-Csv if necessary
# -Delimiter : to define delimiter from your .csv file if it's not a comma
# -Header : if you have a .csv with other informations, using this parameter you can import only named parameters. i.e. -Header Name, Memory
Name Memory
---- ------
Name Memory
VM1  1073741824
VM2  42994967296
VM3  536870912
# -Encoding : this parameter could be useful if your .csv file has some language specific characters. i.e : -Encoding UTF8
````

>[Nota] : you'll notice that Memory Size is on Bytes.

## Step 3 : Using a foreach loop to build VMs

As you can see, I'm using a splat to pass parameters. It's not mandatory but if you have to pass more than 3-4 parameter, this makes the script more readable.

````powershell
foreach ($VM in $VMsList)
    {
    # VM parameters using a splat
    $VMParams                      = @{
                Name               = $VM.Name         # Specifies the name of the new virtual machine. The default name is New virtual machine.
                MemoryStartupBytes = $VM.Memory       # Specifies the amount of memory, in bytes, to assign to the virtual machine. The default value is 512 MB.
                ComputerName       = $VM.HostName     # name of the Host on witch the VM is to be created
                Generation         = $VM.Generation   # Specifies the generation, as an integer, for the virtual machine. The values that are valid in this version of Windows are 1 and 2.
                NewVHDPath         = $VM.VHDPath      # Creates a new virtual hard disk with the specified path and connects it to the new virtual machine. Absolute paths are allowed. If only a file name is specified, the virtual hard disk is created in the default path configured for the host.
                NewVHDSizeBytes    = $VM.VHDSizeBytes # Specifies the size of the dynamic virtual hard disk that is created and attached to the new virtual machine.
                SwitchName         = $VM.SwitchName   # Specifies the friendly name of the virtual switch if you want to connect the new virtual machine to an existing virtual switch to provide connectivity to a network. Hyper-V automatically creates a virtual machine with one virtual network adapter, but connecting it to a virtual switch is optional.
                BootDevice         = $VM.BootDevice   # Specifies the device to use as the boot device for the new virtual machine. Allowed values are CD , Floppy , LegacyNetworkAdapter , IDE , NetworkAdapter, and VHD.
                # ....
                }
    # Create VM
    New-VM @VMParams
    }
````

## Step 4 : save your final script and run it

Of course you are free to add all necessary parameters to build your environment.

>[Nota] : Refer to the Online Help of the cmdlet you'll use to define what parameter is mandatory, what parameter have default value if not define, ...

You can also notice in the output generated by the script that the new VMs are in a State ***Off*** by default.
If you want to start them automatically then, just add after the ````New-VM```` a pipeline with the ````Start-VM```` cmdlet.

With this same principle (pipeline), you can also use other cmdlets like ````Set-VM````, and other ````Set-VMxxx```` cmdlets.

>[Nota] : if you don't start the VM, the output show that MemoryAssigned to the VMs is O. This will change when the VM will start.

## Final word

Of course, it's just a basic and primary approach. Feel free to complete and modify as you want.

Hope this help
